<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enigma Simulator</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    textarea, input, button { width: 100%; margin: 10px 0; padding: 8px; }
    .panel { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 6px; }
    pre { background: #eee; padding: 10px; min-height: 40px; }
  </style>
</head>
<body>
  <div class="panel">
    <h2>Encode / Decode</h2>
    <textarea id="message" placeholder="Message"></textarea>
    <input id="r1" maxlength="1" value="A" />
    <input id="r2" maxlength="1" value="A" />
    <input id="r3" maxlength="1" value="A" />
    <input id="plugboard" placeholder="Plugboard pairs (e.g. AB CD)" />
    <button onclick="process()">Run Enigma</button>
    <pre id="output"></pre>
  </div>

  <script>
    const A = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

    class Rotor {
      constructor(wiring, notch, pos = 0) {
        this.wiring = wiring;
        this.notch = notch;
        this.pos = pos;
      }
      step() {
        this.pos = (this.pos + 1) % 26;
        return this.pos === this.notch;
      }
      fwd(c) {
        const i = (c + this.pos) % 26;
        const o = (this.wiring[i] - this.pos + 26) % 26;
        return o;
      }
      bwd(c) {
        const i = (c + this.pos) % 26;
        const o = (this.wiring.indexOf(i) - this.pos + 26) % 26;
        return o;
      }
    }

    class Enigma {
      constructor(rotors, reflector, plug = {}) {
        this.r = rotors;
        this.ref = reflector;
        this.p = plug;
      }
      enc(c) {
        if (!A.includes(c)) return c;
        let i = A.indexOf(c);
        if (this.r[0].step() && this.r[1].step()) this.r[2].step();

        i = this.p[i] ?? i;
        for (let r of this.r) i = r.fwd(i);
        i = this.ref[i];
        for (let r of [...this.r].reverse()) i = r.bwd(i);
        i = this.p[i] ?? i;

        return A[i];
      }
      run(msg) {
        return msg.toUpperCase().split('').map(c => this.enc(c)).join('');
      }
    }

    const toList = s => s.split('').map(c => A.indexOf(c));
    const REFLECTOR_B = toList("YRUHQSLDPXNGOKMIEBFZCWVJAT");
    const ROTOR_I = toList("EKMFLGDQVZNTOWYHXUSPAIBRCJ");
    const ROTOR_II = toList("AJDKSIRUXBLHWTMCQGZNPYFVOE");
    const ROTOR_III = toList("BDFHJLCPRTXVZNYEIWGAKMUSQO");

    const NOTCH_I = A.indexOf("Q"), NOTCH_II = A.indexOf("E"), NOTCH_III = A.indexOf("V");

    function parsePlugboard(pairs) {
      const map = {};
      pairs.toUpperCase().trim().split(/\s+/).forEach(p => {
        if (p.length === 2) {
          const [a, b] = [A.indexOf(p[0]), A.indexOf(p[1])];
          if (a !== b && a >= 0 && b >= 0) {
            map[a] = b;
            map[b] = a;
          }
        }
      });
      return map;
    }

    function getPos(id) {
      const v = document.getElementById(id).value.toUpperCase();
      return A.indexOf(v);
    }

    function process() {
      const msg = document.getElementById('message').value;
      const r1 = new Rotor(ROTOR_I, NOTCH_I, getPos('r1'));
      const r2 = new Rotor(ROTOR_II, NOTCH_II, getPos('r2'));
      const r3 = new Rotor(ROTOR_III, NOTCH_III, getPos('r3'));
      const plug = parsePlugboard(document.getElementById('plugboard').value);

      const enigma = new Enigma([r1, r2, r3], REFLECTOR_B, plug);
      document.getElementById('output').textContent = enigma.run(msg);
    }
  </script>
</body>
</html>
