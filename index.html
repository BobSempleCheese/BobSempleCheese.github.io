<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Enigma Machine</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: #eee;
    }

    nav {
      background: #222;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
    }

    nav a {
      color: #eee;
      text-decoration: none;
      margin-left: 15px;
      font-weight: bold;
    }

    .container {
      display: flex;
      gap: 20px;
      padding: 20px;
    }

    .section {
      flex: 1;
      background: #1d1d1d;
      padding: 20px;
      border-radius: 10px;
    }

    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      border: none;
      border-radius: 5px;
      resize: vertical;
      background: #222;
      color: #fff;
      font-family: monospace;
    }

    select, input[type="text"] {
      background: #222;
      color: #fff;
      border: none;
      padding: 5px;
      margin-right: 10px;
      border-radius: 5px;
    }

    label {
      display: inline-block;
      margin-right: 10px;
    }

    button {
      background: #333;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background: #444;
    }

    .settings {
      margin: 10px 0;
    }

  </style>
</head>
<body>

<nav>
  <div><strong>Enigma Machine</strong></div>
  <div>
    <a href="enigma.html">Enigma</a>
    <a href="blackjack.html">Blackjack</a>
  </div>
</nav>

<div class="container">
  <div class="section">
    <h2>Encoder</h2>

    <div class="settings">
      <label>Rotors:</label>
      <select id="rotor1"><option>I</option><option>II</option><option>III</option></select>
      <select id="rotor2"><option>II</option><option>III</option><option>I</option></select>
      <select id="rotor3"><option>III</option><option>I</option><option>II</option></select>
    </div>

    <div class="settings">
      <label>Positions:</label>
      <input type="text" id="position1" value="A" maxlength="1" size="1">
      <input type="text" id="position2" value="A" maxlength="1" size="1">
      <input type="text" id="position3" value="A" maxlength="1" size="1">
    </div>

    <div class="settings">
      <label>Plugboard (e.g. AB CD EF):</label>
      <input type="text" id="plugboard" value="">
    </div>

    <textarea id="encoderInput" placeholder="Type your message..."></textarea>
    <button onclick="runEnigma()">Encode</button>
    <textarea id="encodedOutput" readonly placeholder="Encoded result..."></textarea>
  </div>
</div>

<script>
const rotorWiring = {
  I: "EKMFLGDQVZNTOWYHXUSPAIBRCJ",
  II: "AJDKSIRUXBLHWTMCQGZNPYFVOE",
  III: "BDFHJLCPRTXVZNYEIWGAKMUSQO"
};

const notch = {
  I: "Q", II: "E", III: "V"
};

const reflector = {
  B: "YRUHQSLDPXNGOKMIEBFZCWVJAT"
};

function rotate(rotor) {
  return rotor.slice(1) + rotor[0];
}

function stepRotor(rotor, pos) {
  return (rotor + pos).slice(pos) + (rotor + pos).slice(0, pos);
}

function plugboardSwap(text, wiring) {
  for (let pair of wiring.split(' ')) {
    if (pair.length === 2) {
      const a = pair[0].toUpperCase();
      const b = pair[1].toUpperCase();
      text = text.replaceAll(a, '_').replaceAll(b, a).replaceAll('_', b);
    }
  }
  return text;
}

function mod(n, m) {
  return ((n % m) + m) % m;
}

function runEnigma() {
  let rotorNames = [rotor1.value, rotor2.value, rotor3.value];
  let rotors = rotorNames.map(r => rotorWiring[r]);
  let positions = [position1.value, position2.value, position3.value].map(p => p.toUpperCase().charCodeAt(0) - 65);

  let plug = plugboard.value;
  let input = encoderInput.value.toUpperCase().replace(/[^A-Z]/g, "");
  let output = "";

  for (let i = 0; i < input.length; i++) {
    // Step rotors
    positions[2] = (positions[2] + 1) % 26;
    if (positions[2] === notch[rotorNames[2]].charCodeAt(0) - 65) {
      positions[1] = (positions[1] + 1) % 26;
      if (positions[1] === notch[rotorNames[1]].charCodeAt(0) - 65) {
        positions[0] = (positions[0] + 1) % 26;
      }
    }

    let c = input[i];

    // Plugboard in
    c = plugboardSwap(c, plug);

    // Pass through rotors (forward)
    for (let j = 2; j >= 0; j--) {
      let index = mod(c.charCodeAt(0) - 65 + positions[j], 26);
      c = rotors[j][index];
      c = String.fromCharCode(mod(c.charCodeAt(0) - 65 - positions[j], 26) + 65);
    }

    // Reflector
    c = reflector.B[c.charCodeAt(0) - 65];

    // Pass through rotors (reverse)
    for (let j = 0; j < 3; j++) {
      let index = mod(c.charCodeAt(0) - 65 + positions[j], 26);
      c = String.fromCharCode(65 + rotors[j].indexOf(String.fromCharCode(index + 65)));
      c = String.fromCharCode(mod(c.charCodeAt(0) - 65 - positions[j], 26) + 65);
    }

    // Plugboard out
    c = plugboardSwap(c, plug);

    output += c;
  }

  encodedOutput.value = output;
}
</script>

</body>
</html>
